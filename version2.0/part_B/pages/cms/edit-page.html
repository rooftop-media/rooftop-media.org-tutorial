<div class="p-3" id="dynamic-page">
  <i>Loading page...</i>
</div>

<script>

//  Page memory
let page_route = _current_page.split('/edit/')[1];
let page_buffer = [];
let page_data = {};
let edit_el_index = -1;
load_page_elements();

//  Load all page elements from API
function load_page_elements() {
  const http = new XMLHttpRequest();
  http.open('POST', '/api/get-page');
  http.send(JSON.stringify({ page_route: page_route }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log('Page loaded');
        page_data = response.data;
        page_buffer = page_data.content;
        render_buffer();
      } else {
        document.getElementById('dynamic-page').innerHTML = `The page route "<code>/${page_route}</code>" was not found.`;
      }
    }
  }
}

//  Add a new element, in "editable" state
function add_new_element() {
  page_buffer.push({ 
    type: 'p', 
    text: ""
  })
  render_buffer();
}

//  Render the buffer as editable elements
function render_buffer() {
  document.getElementById('dynamic-page').innerHTML = "";
  for (var i = 0; i < page_buffer.length; i++) {
    if (i == edit_el_index) {
      document.getElementById('dynamic-page').innerHTML += `
      <div id="element-type-select">
        Element type: 
        <select id="new-el-type" onchange="update_el(${i})">
          <option value="p">p</option>
          <option value="h1">h1</option>
          <option value="img">img</option>
          <option value="div">div</option>
          <option value="a">a</option>
          <option value="i">i</option>
        </select>
      </div>`;
    } else {
      document.getElementById('dynamic-page').innerHTML += `<div>
        <input 
        type="text" 
        value="${page_buffer[i].text}" 
        id="el-${i}" 
        class="${page_buffer[i].type}"
        oninput="update_text(${i})"
        oncontextmenu="context_menu(${i})"
      />
      </div>`
    }
  }
  document.getElementById('dynamic-page').innerHTML += `<div id="new-el">
    <button onclick="add_new_element()">+ add new element</button>
  </div>`;
  document.getElementById('dynamic-page').innerHTML += `<br/>`;
  document.getElementById('dynamic-page').innerHTML += `<div id="save">
    <button onclick="save_buffer()">Save page changes</button>
  </div>`;
  document.getElementById('dynamic-page').innerHTML += `<div id="error"></div>`;
}

//  Fires when text of a given input is changed.
function update_text(index) {
  page_buffer[index].text = document.getElementById(`el-${index}`).value;
}

//  Fires when "type" of a given input is selected
function update_el(index) {
  page_buffer[index].type = document.getElementById('new-el-type').value;
  edit_el_index = -1;
  render_buffer();
}

//  Fires when "edit type" is clicked in the context menu1
function edit_el(index) {
  edit_el_index = index;
  render_buffer();
  let ctx_menu = document.getElementById("ctx_menu");
  ctx_menu.remove();
}

//  Fires when the user right clicks on an input
function context_menu(index) {
  document.getElementById("ctx_menu") != null ? document.getElementById("ctx_menu").remove() : null;
  let e = window.event;
  e.preventDefault();
  
  document.body.innerHTML += `<div id="ctx_menu" style="left: ${e.clientX}px; top: ${e.clientY}px">
    <div class="ctx_choice" onclick="edit_el(${index})">Edit type</div>
    <div class="ctx_choice" onclick="document.getElementById('ctx_menu').remove()">Close</div>
  </div>`;
}

//  Fires whenever the user clicks on the page, to remove the custom ctx menu
document.body.addEventListener('mousedown', function(ev) {
  //  Don't remove ctx menu on right click
  if (ev.which == 3) { 
    return;
  }
  //  Don't remove ctx menu when clicking the ctx menu (let the ctx menu handle that)
  if (ev.target.id == 'ctx_menu' || ev.target.className == 'ctx_choice' ) {
    return;
  }
  let ctx_menu = document.getElementById("ctx_menu");
  if (ctx_menu != null) {
    ctx_menu.remove();
  }
}, true);

//  Fires when "Save page changes" is clicked.
function save_buffer() {
  console.log("saving...")
  const http = new XMLHttpRequest();
  http.open('POST', '/api/update-page');
  let string_page_buffer = page_buffer; //JSON.stringify(page_buffer);
  http.send(JSON.stringify({ 
    id: page_data.id,
    content: string_page_buffer
  }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Page updated.");
        console.log(response);
        render_buffer();
      } else {
        console.warn("Err")
        document.getElementById('error').innerHTML = response.msg;
      }
    }
  }
}

</script>

<style> 
  #dynamic-page, body {
    position: relative;
  }
  input {
    font-family: CrimsonText;
  }
  input.h1 {
    font-size: 38px;
  }

  #ctx_menu {
    position: absolute;
    background: #efefef;
    border: solid 1px #bfbfbf;
    border-radius: 2px;
    width: 100px;
    min-height: 20px;
  }
  .ctx_choice {
    padding: 5px;
    cursor: pointer;
  }
  .ctx_choice:hover {
    background: #dfdfdf;
  }
  #element-type-select {
    border: solid 1px gray;
    padding: 5px;
    display: inline-block;
  }
</style>