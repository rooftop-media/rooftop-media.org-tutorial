<div class="p-3 center-column" id="dynamic-page">
  <i>Loading page...</i>
</div>

<script>

////  SECTION 1: Page memory
let page_route = _current_page.split('/edit/')[1];
let page_buffer = '';
let page_data = {};

////  SECTION 2: Render

//  Renders the text editor, final page, or "page does not exist" message.
function render_page() {
  let page_editor = `
  Route: /
  <input id="page-route" type="text" value="${page_route}" oninput="update_pageRoute()" /><br/><br/>
  <div class="page-title-editor">
    <input id="page-title" type="text" value="${page_data.page_title}" oninput="update_pageTitle()">
    <button onclick="cancel()">Cancel</button>
    <button style="background: #3A7B64;" onclick="save()">Save</button>
  </div>`;
  page_editor += `<div id="error"></div>`;
  page_editor += `<textarea id="page-buffer" value="${page_buffer}" oninput="update_buffer()">${page_buffer}</textarea/><br/><br/>`;
  page_editor += `<button onclick="preview()">Preview</button>`;
  document.getElementById('dynamic-page').innerHTML = page_editor;
}

////  SECTION 3: Event reactions

//  Fires when new page content is typed.
function update_buffer() {
  page_buffer = document.getElementById('page-buffer').value;
}

//  Fires when the page title is changed. 
function update_pageTitle() {
  page_data.page_title = document.getElementById('page-title').value;
}

function update_pageRoute() {
  page_route = document.getElementById('page-route').value;
}

//  Fires when "Save page changes" is clicked.
function save() {
  console.log("saving...")
  const http = new XMLHttpRequest();
  http.open('POST', '/api/update-page');
  http.send(JSON.stringify({ 
    id: page_data.id,
    page_title: page_data.page_title,
    content: page_buffer,
    page_route: page_route
  }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Page updated.");
        console.log(response);
        if (_current_page.split('/edit/')[1] != page_route) {
          window.location.href = '/edit/' + page_route;
        }
        render_page();
      } else {
        console.warn("Err")
        document.getElementById('error').innerHTML = response.msg;
      }
    }
  }
}

//  Fires when the cancel button is clicked.
function cancel() {
  if (confirm("Are you sure? Changes will not be saved!")) {
    window.location.href = '/edit/' + page_route;
  }
}

////  SECTION 4: Boot
//  Load all page elements from API, then render buffer
function load_page() {
  const http = new XMLHttpRequest();
  http.open('POST', '/api/get-page');
  http.send(JSON.stringify({ page_route: page_route }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Creating page.");
        console.log(response.data);
        page_data = response.data;
        page_buffer = page_data.content || "";
        render_page();
      } else {
        document.getElementById('dynamic-page').innerHTML = response.msg;
      }
    }
  }
}
load_page();

</script>

<style> 
  #dynamic-page {
    position: relative;
  }
  input {
    font-family: CrimsonText;
    width: 60%;
  }
  input, textarea {
    background: var(--brown);
    color: white;
    border: solid 1px black;
    
  }
  input:focus, textarea:focus {
    outline: solid 1px var(--yellow);
  }
  input#page-title {
    margin: 0.67em 0px;
    padding: 0px;
    font-size: 2em;
  }
  
  textarea {
    min-height: 60vh;
    min-width: 100%;
  }

  .page-title-editor {
    display: flex;
    justify-content: space-between;
    align-items: center;;
  }

  #dynamic-page button {
    padding: 10px 0px;
    border-radius: 5px;
    width: 15%;
    background: var(--light-brown);
    color: var(--yellow);
    border: 1px solid var(--brown);
    cursor: pointer;
  }

</style>