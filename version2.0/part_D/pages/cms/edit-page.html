<div class="p-3 center-column" id="dynamic-page">
  <i>Loading page...</i>
</div>

<script>

////  SECTION 1: Page memory
let page_route = _current_page.split('/edit/')[1];
let buffer_data = {};
let page_data = {};
let is_saved = true;

////  SECTION 2: Render

//  Renders the text editor, final page, or "page does not exist" message.
function render_page() {
  let page_editor = `
  <div class="flex-row">
    <div style="width:40%;">Route: / <input id="page-route" type="text" value="${buffer_data.page_route}" oninput="update_pageRoute()" /></div>
    <button onclick="toggle_publicity()">Make ${buffer_data.is_public ? 'Private' : 'Public'}</button>
  </div>
  <div class="flex-row">
    <input id="page-title" type="text" value="${buffer_data.page_title}" oninput="update_pageTitle()">
    <button onclick="cancel()">Cancel</button>
    <button id="save" onclick="save()">Save</button>
  </div>`;
  page_editor += `<div id="error"></div>`;
  page_editor += `<textarea id="page-buffer" oninput="update_buffer(event.currentTarget.value)">${buffer_data.content}</textarea/><br/><br/>`;
  page_editor += `<button onclick="render_preview()">Preview</button>
  <button style="margin-left:20px;" onclick="window.location.href = '/${page_route}'">Go to Page</button>`;
  document.getElementById('dynamic-page').innerHTML = page_editor;
  check_if_saved();
}

function render_preview() {
  document.getElementById('dynamic-page').innerHTML = `<button onclick="render_page()">Edit</button><br/><hr/><br/>`;
  document.getElementById('dynamic-page').innerHTML += buffer_data.content;
}

////  SECTION 3: Event reactions

//  Fired if unsaved changes exist
function beforeUnloadListener(event) {
  event.preventDefault();
  return (event.returnValue = "");
};

//  Fired in render_page() and in any buffer editing function
function check_if_saved() {
  is_saved = (buffer_data.content == page_data.content) && (buffer_data.page_title == page_data.page_title) 
    && (buffer_data.is_public == page_data.is_public) && (buffer_data.page_route == page_data.page_route);
  if (!is_saved) {
    addEventListener("beforeunload", beforeUnloadListener, { capture: true });
    document.getElementById('save').classList.remove('inactive');
  } else {
    removeEventListener("beforeunload", beforeUnloadListener, { capture: true, });
    document.getElementById('save').classList.add('inactive');
  }
}

//  Fires when new page content is typed.
function update_buffer(newval) {
  buffer_data.content = newval;
  check_if_saved();
}

//  Fires when the page title is changed. 
function update_pageTitle() {
  buffer_data.page_title = document.getElementById('page-title').value;
  check_if_saved();
}

function update_pageRoute() {
  buffer_data.page_route = document.getElementById('page-route').value;
  check_if_saved();
}

function toggle_publicity() {
  buffer_data.is_public = !buffer_data.is_public;
  render_page();
}

//  Fires when "Save page changes" is clicked.
function save() {
  console.log("saving...")
  const http = new XMLHttpRequest();
  http.open('POST', '/api/update-page');
  http.send(JSON.stringify({ 
    id: page_data.id,
    page_title: buffer_data.page_title,
    content: buffer_data.content,
    page_route: buffer_data.page_route,
    is_public: buffer_data.is_public,
    session_id: _session_id
  }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Page updated.");
        page_data.content = buffer_data.content;
        page_data.page_title = buffer_data.page_title;
        page_data.page_route = buffer_data.page_route;
        page_data.is_public = buffer_data.is_public;
        render_page();
        if (_current_page.split('/edit/')[1] != buffer_data.page_route) {
          window.location.href = '/edit/' + buffer_data.page_route;
        }
      } else {
        console.warn("Err")
        document.getElementById('error').innerHTML = response.msg;
      }
    }
  }
}

//  Fires when the cancel button is clicked.
function cancel() {
  if (confirm("Are you sure? Changes will not be saved!")) {
    window.location.href = '/edit/' + page_route;
  }
}



////  SECTION 4: Boot
//  Load all page elements from API, then render buffer
function load_page() {
  const http = new XMLHttpRequest();
  http.open('GET', `/api/page?page_route=${page_route}`);
  http.send();
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Loading page.");
        page_data = response.data;
        if (page_data.created_by != _current_user.id) {
          document.getElementById('dynamic-page').innerHTML = "You don't have permission to edit this page.";
          return;
        }
        buffer_data.content = page_data.content || "";
        buffer_data.page_title = page_data.page_title || "";
        buffer_data.page_route = page_data.page_route;
        buffer_data.is_public = page_data.is_public;
        render_page();
      } else {
        document.getElementById('dynamic-page').innerHTML = response.msg;
      }
    }
  }
}
function current_user_loaded() {
  load_page();
}
</script>

<style> 
  #dynamic-page {
    position: relative;
  }
  #dynamic-page input {
    font-family: CrimsonText;
    width: 60%;
  }
  #dynamic-page input, #dynamic-page textarea {
    background: var(--brown);
    color: white;
    border: solid 1px black;
    
  }
  #dynamic-page input:focus, #dynamic-page textarea:focus {
    outline: solid 1px var(--yellow);
  }

  input#page-route {
    font-size: 1em;
  }

  input#page-title {
    margin: 0.67em 0px;
    padding: 0px;
    font-size: 2em;
  }
  
  #page-buffer {
    min-height: 60vh;
    min-width: 100%;
  }

  .flex-row {
    display: flex;
    justify-content: space-between;
    align-items: center;;
  }

  #dynamic-page button {
    padding: 10px 0px;
    border-radius: 5px;
    width: 15%;
    background: var(--light-brown);
    color: var(--yellow);
    border: 1px solid var(--brown);
    cursor: pointer;
  }

  #dynamic-page button#save {
    background: #3A7B64;
  }
  .inactive {
    opacity: 0.5;
  }

</style>