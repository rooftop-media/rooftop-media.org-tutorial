<div class="p-3 center-column" id="dynamic-page">
  <i>Loading page...</i>
</div>

<script>

////  SECTION 1: Page memory
let page_route = _current_page.split('/edit/')[1];
let page_buffer = '';
let page_data = {};

////  SECTION 2: Render

//  Renders the text editor, final page, or "page does not exist" message.
function render_page() {
  let page_editor = `
  <div class="flex-row">
    <div style="width:40%;">Route: / <input id="page-route" type="text" value="${page_route}" oninput="update_pageRoute()" /></div>
    <button onclick="toggle_publicity()">Make ${page_data.is_public ? 'Private' : 'Public'}</button>
  </div>
  <div class="flex-row">
    <input id="page-title" type="text" value="${page_data.page_title}" oninput="update_pageTitle()">
    <button onclick="cancel()">Cancel</button>
    <button style="background: #3A7B64;" onclick="save()">Save</button>
  </div>`;
  page_editor += `<div id="error"></div>`;
  page_editor += `<textarea id="page-buffer" oninput="update_buffer(event.currentTarget.value)">${page_buffer}</textarea/><br/><br/>`;
  page_editor += `<button onclick="render_preview()">Preview</button>
  <button style="margin-left:20px;" onclick="window.location.href = '/${page_route}'">Go to Page</button>`;
  document.getElementById('dynamic-page').innerHTML = page_editor;
}

function render_preview() {
  document.getElementById('dynamic-page').innerHTML = `<button onclick="render_page()">Edit</button><br/><hr/><br/>`;
  document.getElementById('dynamic-page').innerHTML += page_buffer;
}

////  SECTION 3: Event reactions

//  Fired if unsaved changes exist
function beforeUnloadListener(event) {
  event.preventDefault();
  return (event.returnValue = "");
};

//  Fires when new page content is typed.
function update_buffer(newval) {
  page_buffer = newval;
  addEventListener("beforeunload", beforeUnloadListener, { capture: true })
}

//  Fires when the page title is changed. 
function update_pageTitle() {
  page_data.page_title = document.getElementById('page-title').value;
  addEventListener("beforeunload", beforeUnloadListener, { capture: true })
}

function update_pageRoute() {
  page_route = document.getElementById('page-route').value;
  addEventListener("beforeunload", beforeUnloadListener, { capture: true })
}

function toggle_publicity() {
  page_data.is_public = !page_data.is_public;
  render_page();
  addEventListener("beforeunload", beforeUnloadListener, { capture: true })
}

//  Fires when "Save page changes" is clicked.
function save() {
  console.log("saving...")
  const http = new XMLHttpRequest();
  http.open('POST', '/api/update-page');
  http.send(JSON.stringify({ 
    id: page_data.id,
    page_title: page_data.page_title,
    content: page_buffer,
    page_route: page_route,
    is_public: page_data.is_public, 
    session_id: _session_id
  }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Page updated.");
        if (_current_page.split('/edit/')[1] != page_route) {
          window.location.href = '/edit/' + page_route;
        }
        removeEventListener("beforeunload", beforeUnloadListener, { capture: true, });
        render_page();
      } else {
        console.warn(`Err: ${response.msg}`);
        document.getElementById('error').innerHTML = response.msg;
      }
    }
  }
}

//  Fires when the cancel button is clicked.
function cancel() {
  if (confirm("Are you sure? Changes will not be saved!")) {
    window.location.href = '/edit/' + page_route;
  }
}



////  SECTION 4: Boot
//  Load all page elements from API, then render buffer
function load_page() {
  const http = new XMLHttpRequest();
  http.open('POST', '/api/get-page');
  http.send(JSON.stringify({ 
    page_route: page_route
  }));
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Loading page.");
        page_data = response.data;
        if (page_data.created_by != _current_user.id) {
          document.getElementById('dynamic-page').innerHTML = "You don't have permission to edit this page.";
          return;
        }
        page_buffer = page_data.content || "";
        render_page();
      } else {
        document.getElementById('dynamic-page').innerHTML = response.msg;
      }
    }
  }
}
function current_user_loaded() {
  load_page();
}

</script>

<style> 
  #dynamic-page {
    position: relative;
  }
  #dynamic-page input {
    font-family: CrimsonText;
    width: 60%;
  }
  #dynamic-page input, #dynamic-page textarea {
    background: var(--brown);
    color: white;
    border: solid 1px black;
    
  }
  #dynamic-page input:focus, #dynamic-page textarea:focus {
    outline: solid 1px var(--yellow);
  }

  input#page-route {
    font-size: 1em;
  }

  input#page-title {
    margin: 0.67em 0px;
    padding: 0px;
    font-size: 2em;
  }
  
  #page-buffer {
    min-height: 60vh;
    min-width: 100%;
  }

  .flex-row {
    display: flex;
    justify-content: space-between;
    align-items: center;;
  }

  #dynamic-page button {
    padding: 10px 0px;
    border-radius: 5px;
    width: 15%;
    background: var(--light-brown);
    color: var(--yellow);
    border: 1px solid var(--brown);
    cursor: pointer;
  }

</style>