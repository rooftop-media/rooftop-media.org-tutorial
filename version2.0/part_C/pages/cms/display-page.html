<div class="p-3 center-column" id="dynamic-page">
  <i>Loading page...</i>
</div>

<script>
////  SECTION 1: Page memory
let page_route = _current_page.split('/')[1];
let page_data = {};

////  SECTION 2: Render
//  Renders the text editor, final page, or "page does not exist" message.
function render_page() {
  let markup = page_data.content;
  let page = markup_to_html(markup); //  markup -> html 
  document.getElementById('dynamic-page').innerHTML = page;
}

////  SECTION 3: Functions 
function markup_to_html(markup) {
  return markup;
  let tokens = markup_to_tokens(markup);
  let openTagParse = parse_open_tags(tokens);
  let whitespaceParse = parse_whitespace(openTagParse);
  console.log(whitespaceParse);
  return JSON.stringify(whitespaceParse);
}

//  Tokens include <, /, =, ", ', >, whitespace, and text. 
function markup_to_tokens(markup) {
  let tokens = [];
  let tokenNames = {
    '<': 'LESS-THAN',
    '/': 'FORWARD-SLASH',
    '=': 'EQUALS',
    '"': 'DOUBLE-QUOTE',
    "'": 'SINGLE-QUOTE',
    '>': 'GREATER-THAN'
  }
  let tokenKeys = Object.keys(tokenNames);
  let currentText = ''

  function addCurrentText() {
    if (currentText.length > 0) {
      tokens.push({ type: 'TEXT', value: currentText });
      currentText = '';
    }
  }
  
  for (let i = 0; i < markup.length; i++) {
    if (tokenKeys.includes(markup[i])) {
      addCurrentText();
      tokens.push({ type: tokenNames[markup[i]] });
    } else if (markup[i] == ' ' && tokens[tokens.length-1].type != 'WHITESPACE') {
      addCurrentText();
      tokens.push({ type: 'WHITESPACE' });
    } else {
      currentText += markup[i];
    }
  }
  return tokens;
}

//  Tokens include OPEN-TAGs, /, =, ", ', >, whitespace, and text. 
function parse_open_tags(tokens) {
  let parsedTokens = [];
  let foundOpenTag = false;

  for (let i = 0; i < tokens.length; i++) {
    if (tokens[i].type == 'LESS-THAN') {
      foundOpenTag = true;
    }
    if (foundOpenTag && tokens[i].type == 'TEXT') { //  If the previous was < and this is TEXT...
      parsedTokens.pop();  //  Remove the last 'LESS-THAN'
      parsedTokens.push({ type: 'OPEN-TAG', value: tokens[i].value });
      foundOpenTag = false;
    } else {
      parsedTokens.push(tokens[i]);
      foundOpenTag = false;
    }
  }
  return parsedTokens;
}

//  Tokens include OPEN-TAGs, /, =, ", ', >, and text. 
function parse_whitespace(tokens) {
  let parsedTokens = [];
  let currentText = '';
  
  function addCurrentText() {
    if (currentText.length > 0) {
      parsedTokens.push({ type: 'TEXT', value: currentText });
      currentText = '';
    }
  }

  for (let i = 0; i < tokens.length; i++) {
    if (tokens[i].type == 'WHITESPACE') {
      currentText += ' ';
    } else if (tokens[i].type == 'TEXT') {
      currentText += tokens[i].value;
    } else {
      addCurrentText();
      parsedTokens.push(tokens[i]);
    }
  }
  return parsedTokens;
}

////  SECTION 4: Boot
//  Load all page elements from API, then render buffer
function load_page() {
  const http = new XMLHttpRequest();
  http.open('GET', `/api/page?page_route=${page_route}`);
  http.send();
  http.onreadystatechange = (e) => {
    let response;      
    if (http.readyState == 4 && http.status == 200) {
      response = JSON.parse(http.responseText);
      if (!response.error) {
        console.log("Response recieved! Creating page.");
        console.log(response.data);
        page_data = response.data;
        render_page();
      } else {
        document.getElementById('dynamic-page').innerHTML = response.msg;
      }
    }
  }
}
load_page();

</script>